<article>
  <header>
    <h1>Pasteboard</h1>
  </header>
  
  <div class="notes-container">
    <% if (notes && notes.length > 0) { %>
      <% notes.forEach(function(note) { %>
        <div class="note-item" data-note-id="<%= note.id %>">
          <div class="note-content">
            <pre><%= note.content %></pre>
          </div>
          <div class="note-actions">
            <button 
              class="action-btn copy-btn" 
              data-action="copy"
              data-note-id="<%= note.id %>"
              title="Copy to clipboard"
              aria-label="Copy to clipboard">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
              </svg>
            </button>
            <button 
              class="action-btn edit-btn" 
              data-action="edit"
              data-note-id="<%= note.id %>"
              title="Edit"
              aria-label="Edit note">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
              </svg>
            </button>
            <button 
              class="action-btn delete-btn" 
              data-action="delete"
              data-note-id="<%= note.id %>"
              title="Delete"
              aria-label="Delete note">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
              </svg>
            </button>
          </div>
        </div>
      <% }); %>
    <% } else { %>
      <p class="no-notes">No notes yet. Create your first note using the API!</p>
    <% } %>
  </div>
</article>

<!-- Floating Action Button -->
<button class="fab" onclick="openCreateModal()" aria-label="Create new note" title="Create new note">
  <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
    <line x1="12" y1="5" x2="12" y2="19"></line>
    <line x1="5" y1="12" x2="19" y2="12"></line>
  </svg>
</button>

<!-- Create Note Modal -->
<div id="createModal" class="modal" style="display: none;">
  <div class="modal-content">
    <header>
      <h2>Create New Note</h2>
    </header>
    <form id="createForm">
      <label for="createContent">Content</label>
      <textarea id="createContent" name="content" rows="10" required></textarea>
      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <button type="submit">Create</button>
        <button type="button" onclick="closeCreateModal()" class="secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal" style="display: none;">
  <div class="modal-content">
    <header>
      <h2>Edit Note</h2>
    </header>
    <form id="editForm">
      <input type="hidden" id="editNoteId" name="noteId">
      <label for="editContent">Content</label>
      <textarea id="editContent" name="content" rows="10" required></textarea>
      <div style="display: flex; gap: 1rem; margin-top: 1rem;">
        <button type="submit">Save</button>
        <button type="button" onclick="closeEditModal()" class="secondary">Cancel</button>
      </div>
    </form>
  </div>
</div>

<script>
  const sessionId = '<%= sessionId %>';
  
  function copyNote(noteId) {
    const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
    const noteContent = noteItem.querySelector('.note-content pre').textContent;
    
    navigator.clipboard.writeText(noteContent).then(() => {
      // Show feedback
      const btn = noteItem.querySelector('.copy-btn');
      const originalTitle = btn.getAttribute('title');
      btn.setAttribute('title', 'Copied!');
      setTimeout(() => {
        btn.setAttribute('title', originalTitle);
      }, 2000);
    }).catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard');
    });
  }
  
  let originalEditContent = '';
  let originalCreateContent = '';
  
  function editNote(noteId) {
    const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
    const noteContent = noteItem.querySelector('.note-content pre').textContent;
    
    document.getElementById('editNoteId').value = noteId;
    document.getElementById('editContent').value = noteContent;
    originalEditContent = noteContent;
    document.getElementById('editModal').style.display = 'flex';
  }
  
  function closeEditModal(force = false) {
    const currentContent = document.getElementById('editContent').value;
    const hasChanges = currentContent.trim() !== originalEditContent.trim();
    
    if (!force && hasChanges) {
      if (!confirm('You have unsaved changes. Are you sure you want to close?')) {
        return;
      }
    }
    
    document.getElementById('editModal').style.display = 'none';
    document.getElementById('editForm').reset();
    originalEditContent = '';
  }
  
  function openCreateModal() {
    document.getElementById('createModal').style.display = 'flex';
    document.getElementById('createContent').focus();
    originalCreateContent = '';
  }
  
  function closeCreateModal(force = false) {
    const currentContent = document.getElementById('createContent').value;
    const hasChanges = currentContent.trim() !== '';
    
    if (!force && hasChanges) {
      if (!confirm('You have unsaved changes. Are you sure you want to close?')) {
        return;
      }
    }
    
    document.getElementById('createModal').style.display = 'none';
    document.getElementById('createForm').reset();
    originalCreateContent = '';
  }
  
  function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) {
      return;
    }
    
    fetch(`/api/notes/${noteId}`, {
      method: 'DELETE',
      headers: {
        'X-Session-ID': sessionId
      }
    })
    .then(response => {
      if (response.ok) {
        const noteItem = document.querySelector(`.note-item[data-note-id="${noteId}"]`);
        noteItem.remove();
        
        // Check if no notes left
        const notesContainer = document.querySelector('.notes-container');
        if (notesContainer.querySelectorAll('.note-item').length === 0) {
          notesContainer.innerHTML = '<p class="no-notes">No notes yet. Create your first note using the API!</p>';
        }
      } else {
        alert('Failed to delete note');
      }
    })
    .catch(err => {
      console.error('Error deleting note:', err);
      alert('Error deleting note');
    });
  }
  
  // Event delegation for action buttons
  document.addEventListener('DOMContentLoaded', function() {
    document.querySelector('.notes-container')?.addEventListener('click', function(e) {
      const btn = e.target.closest('.action-btn');
      if (!btn) return;
      
      const action = btn.getAttribute('data-action');
      const noteId = btn.getAttribute('data-note-id');
      
      if (action === 'copy') {
        copyNote(noteId);
      } else if (action === 'edit') {
        editNote(noteId);
      } else if (action === 'delete') {
        deleteNote(noteId);
      }
    });
    
    // Handle edit form submission
    document.getElementById('editForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const noteId = document.getElementById('editNoteId').value;
      const content = document.getElementById('editContent').value;
      
      fetch(`/api/notes/${noteId}`, {
        method: 'PUT',
        headers: {
          'X-Session-ID': sessionId,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content })
      })
      .then(response => response.json())
      .then(data => {
        if (data.note) {
          // Close modal with force to skip confirmation
          closeEditModal(true);
          // Reload page to show updated note
          window.location.reload();
        } else {
          alert('Failed to update note');
        }
      })
      .catch(err => {
        console.error('Error updating note:', err);
        alert('Error updating note');
      });
    });
    
    // Close modals when clicking outside
    window.addEventListener('click', function(event) {
      const editModal = document.getElementById('editModal');
      const createModal = document.getElementById('createModal');
      if (event.target === editModal) {
        closeEditModal();
      }
      if (event.target === createModal) {
        closeCreateModal();
      }
    });
    
    // Handle create form submission
    document.getElementById('createForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const content = document.getElementById('createContent').value;
      
      fetch('/api/notes', {
        method: 'POST',
        headers: {
          'X-Session-ID': sessionId,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ content: content })
      })
      .then(response => response.json())
      .then(data => {
        if (data.note) {
          // Close modal with force to skip confirmation
          closeCreateModal(true);
          // Reload page to show new note
          window.location.reload();
        } else {
          alert('Failed to create note');
        }
      })
      .catch(err => {
        console.error('Error creating note:', err);
        alert('Error creating note');
      });
    });
  });
</script>
